# B3-并发请求压测报告

## 测试环境

| 项目 | 配置 |
|------|------|
| CPU | Apple M4 |
| CPU核心数 | 10 |
| 内存 | 24 GB |
| 操作系统 | macOS 15.7.3 |
| 编译器 | Apple clang 17.0.0 |
| 测试日期 | 2026-01-30 |

## 测试概述

本测试对比Stdio和HTTP两种传输协议在不同并发级别下的性能表现。

**重要更新**: HTTP协议已支持Keep-Alive连接复用，性能大幅提升。

## 测试结果汇总

### Stdio传输协议

| 请求规模 | 平均耗时 | QPS | 平均延迟 |
|----------|----------|-----|----------|
| 100请求 | 0.0276s | 3,622 | 0.276ms |
| 1000请求 | 0.0434s | 23,049 | 0.043ms |
| 5000请求 | 0.1049s | **47,687** | 0.021ms |

**工具调用性能**：
- add工具 1000次调用：QPS 16,079

### HTTP传输协议 (Keep-Alive)

#### 单连接性能测试

| 测试场景 | 请求数 | QPS | 平均延迟 | P95延迟 | P99延迟 |
|----------|--------|-----|----------|---------|---------|
| ping | 1000 | **24,464** | 0.04ms | 0.08ms | 0.14ms |
| tools/call | 1000 | **21,851** | 0.05ms | 0.09ms | 0.15ms |
| resources/read | 1000 | **25,893** | 0.04ms | 0.05ms | 0.10ms |
| tools/list | 1000 | **19,225** | 0.05ms | 0.08ms | 0.12ms |
| resources/list | 1000 | **24,299** | 0.04ms | 0.06ms | 0.11ms |
| prompts/list | 1000 | **25,620** | 0.04ms | 0.06ms | 0.10ms |

#### 并发扩展性测试

| 并发数 | 总请求数 | QPS | 平均延迟 | P95延迟 | 成功率 |
|--------|----------|-----|----------|---------|--------|
| 1 | 100 | 962 | 0.07ms | 0.11ms | 100% |
| 2 | 200 | 1,923 | 0.06ms | 0.12ms | 100% |
| 4 | 400 | 3,846 | 0.08ms | 0.13ms | 100% |
| 8 | 800 | 7,767 | 0.06ms | 0.10ms | 100% |
| 16 | 1600 | 15,238 | 0.11ms | 0.19ms | 100% |
| 32 | 3200 | **31,068** | 0.12ms | 0.21ms | 100% |

## 性能对比

### QPS对比 (优化后)

```
Stdio (5000请求):     ████████████████████████████████████████████████ 47,687
HTTP (32并发):        ██████████████████████████████████ 31,068
HTTP (单连接ping):    ██████████████████████████ 24,464
```

### 延迟对比 (优化后)

```
Stdio最低延迟:   0.021ms  █
HTTP平均延迟:    0.04ms   ██
HTTP P99延迟:    0.14ms   ███████
```

### 性能比值 (优化后)

| 指标 | Stdio | HTTP (Keep-Alive) | 比值 |
|------|-------|-------------------|------|
| 峰值QPS | 47,687 | 31,068 | 1.5x |
| 最低延迟 | 0.021ms | 0.04ms | 1.9x |

### 优化前后对比

| 指标 | 优化前 (无Keep-Alive) | 优化后 (Keep-Alive) | 提升倍数 |
|------|----------------------|---------------------|----------|
| 单连接QPS | 6,270 | 24,464 | **3.9x** |
| 平均延迟 | 15.24ms | 0.04ms | **381x** |
| 32并发QPS | - | 31,068 | - |

## 分析结论

### Keep-Alive优化效果

1. **QPS提升3.9倍**：从6,270提升到24,464
2. **延迟降低381倍**：从15.24ms降低到0.04ms
3. **线性扩展**：QPS随并发数近乎线性增长
4. **100%成功率**：所有并发级别均无失败请求

### Stdio优势

1. **极高吞吐量**：峰值QPS达47,687
2. **超低延迟**：最低0.021ms
3. **零网络开销**：直接进程间通信
4. **适用场景**：本地AI代理、CLI工具、IDE插件

### HTTP优势 (Keep-Alive)

1. **高性能**：单连接QPS超过24,000
2. **优秀扩展性**：32并发达31,068 QPS
3. **低延迟**：平均0.04ms，P99仅0.14ms
4. **网络透明**：支持跨机器通信
5. **适用场景**：微服务、Web应用、分布式系统

## 选型建议

| 场景 | 推荐协议 | 原因 |
|------|----------|------|
| 本地AI代理 | Stdio | 最高性能 |
| CLI工具 | Stdio | 简单直接 |
| Web服务 | HTTP | 网络访问，性能优秀 |
| 微服务 | HTTP | 分布式部署，高并发 |
| IDE插件 | Stdio | 低延迟响应 |
| 跨机器调用 | HTTP | 网络透明 |
| 高并发场景 | HTTP | 线性扩展能力 |

## 已完成优化

1. **HTTP Keep-Alive支持**
   - 连接复用，避免重复握手
   - 每个连接独立的初始化状态
   - 循环处理请求直到连接关闭

2. **协程异步模型**
   - Handler改为协程返回
   - processRequest使用协程
   - 非阻塞IO操作

3. **连接级别状态管理**
   - 初始化状态绑定到连接
   - 支持多客户端并发

## 后续优化方向

### 短期优化

1. HTTP连接池（客户端）
2. 批量请求支持
3. 请求超时优化

### 中期优化

1. HTTP/2多路复用
2. 内存池管理
3. JSON零拷贝解析

### 长期优化

1. WebSocket支持
2. gRPC协议支持
3. 自定义二进制协议
